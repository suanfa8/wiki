"use strict";(self.webpackChunkblog_tools=self.webpackChunkblog_tools||[]).push([[5080],{3836:(s,n,a)=>{a.r(n),a.d(n,{data:()=>e});const e={key:"v-5acd4e0e",path:"/Redis/14-Redis-Cluster.html",title:"14-Redis集群",lang:"en-US",frontmatter:{},excerpt:"",headers:[{level:3,title:"14.1 集群",slug:"_14-1-集群",children:[]},{level:3,title:"14.2 集群架构图",slug:"_14-2-集群架构图",children:[]},{level:3,title:"14.3 集群细节",slug:"_14-3-集群细节",children:[]},{level:3,title:"14.4 集群搭建",slug:"_14-4-集群搭建",children:[]},{level:2,title:"",slug:"",children:[]}],filePathRelative:"Redis/14-Redis-Cluster.md",git:{updatedTime:163819854e4,contributors:[{name:"suanfa8",email:"45396320+suanfa8@users.noreply.github.com",commits:3}]}}},9066:(s,n,a)=>{a.r(n),a.d(n,{default:()=>l});const e=(0,a(6252).uE)('<h1 id="_14-redis集群" tabindex="-1"><a class="header-anchor" href="#_14-redis集群" aria-hidden="true">#</a> 14-Redis集群</h1><h3 id="_14-1-集群" tabindex="-1"><a class="header-anchor" href="#_14-1-集群" aria-hidden="true">#</a> 14.1 集群</h3><p>Redis 在 3.0 后开始支持 Cluster 模式，目前 Redis 的集群支持节点的自动发现，支持 slave-master 选举和容错，支持在线分片（sharding shard）等特性。</p><p>reshard</p><h3 id="_14-2-集群架构图" tabindex="-1"><a class="header-anchor" href="#_14-2-集群架构图" aria-hidden="true">#</a> 14.2 集群架构图</h3><p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gwtozlpzpkj311b0u0jtr.jpg" alt="img"></p><h3 id="_14-3-集群细节" tabindex="-1"><a class="header-anchor" href="#_14-3-集群细节" aria-hidden="true">#</a> 14.3 集群细节</h3><ul><li>所有的 Redis 节点彼此互联（PING-PONG 机制），内部使用二进制协议优化传输速度和带宽；</li><li>节点的 <code>fail</code> 是通过集群中超过半数的节点检测失效时才生效；</li><li>客户端与 Redis 节点直连，不需要中间 proxy 层。客户端不需要连接集群所有节点，连接集群中任何一个可用节点即可；</li><li><code>redis-cluster</code> 把所有的物理节点映射到[0-16383]slot上，<code>cluster</code> 负责维护 <code>node&lt;-&gt;slot&lt;-&gt;value</code>。</li></ul><p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gwtozq0fu2j31520u0wkr.jpg" alt="image-20200629165226329"></p><h3 id="_14-4-集群搭建" tabindex="-1"><a class="header-anchor" href="#_14-4-集群搭建" aria-hidden="true">#</a> 14.4 集群搭建</h3><p>判断一个是集群中的节点是否可用,是集群中的所用主节点选举过程,如果半数以上的节点认为当前节点挂掉,那么当前节点就是挂掉了,所以搭建redis集群时建议节点数最好为奇数，<strong>搭建集群至少需要三个主节点,三个从节点,至少需要6个节点</strong>。</p><div class="language-markdown ext-md line-numbers-mode"><pre class="language-markdown"><code><span class="token title important"><span class="token punctuation">#</span> 1.准备环境安装ruby以及redis集群依赖</span>\n<span class="token list punctuation">-</span> yum install -y ruby rubygems\n<span class="token list punctuation">-</span> gem install redis-xxx.gem\n\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gwtozoxbvuj31ke0b4wis.jpg" alt="image-20200627193219366"></p><p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gwtozqql00j31iq01i74e.jpg" alt="image-20200627193348905"></p><div class="language-markdown ext-md line-numbers-mode"><pre class="language-markdown"><code><span class="token title important"><span class="token punctuation">#</span> 2.在一台机器创建7个目录</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gwtozmc5ojj32cs0o2n3c.jpg" alt="image-20200627193849867"></p><div class="language-markdown ext-md line-numbers-mode"><pre class="language-markdown"><code><span class="token title important"><span class="token punctuation">#</span> 3.每个目录复制一份配置文件</span>\n[root@localhost <span class="token strike"><span class="token punctuation">~</span><span class="token content">]# cp redis-4.0.10/redis.conf 7000/\n[root@localhost </span><span class="token punctuation">~</span></span>]# cp redis-4.0.10/redis.conf 7001/\n[root@localhost <span class="token strike"><span class="token punctuation">~</span><span class="token content">]# cp redis-4.0.10/redis.conf 7002/\n[root@localhost </span><span class="token punctuation">~</span></span>]# cp redis-4.0.10/redis.conf 7003/\n[root@localhost <span class="token strike"><span class="token punctuation">~</span><span class="token content">]# cp redis-4.0.10/redis.conf 7004/\n[root@localhost </span><span class="token punctuation">~</span></span>]# cp redis-4.0.10/redis.conf 7005/\n[root@localhost ~]# cp redis-4.0.10/redis.conf 7006/\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gwtozkpkl8j31wa0a041g.jpg" alt="image-20200627194103354"></p><div class="language-markdown ext-md line-numbers-mode"><pre class="language-markdown"><code><span class="token title important"><span class="token punctuation">#</span> 4.修改不同目录配置文件</span>\n<span class="token list punctuation">-</span> port \t6379 .....                \t\t //修改端口\n<span class="token list punctuation">-</span> bind  0.0.0.0                   \t\t //开启远程连接\n<span class="token list punctuation">-</span> cluster-enabled  yes \t        \t\t\t //开启集群模式\n<span class="token list punctuation">-</span> cluster-config-file  nodes-port.conf //集群节点配置文件\n<span class="token list punctuation">-</span> cluster-node-timeout  5000      \t   //集群节点超时时间\n<span class="token list punctuation">-</span> appendonly  yes   \t\t               //开启AOF持久化\n\n<span class="token title important"><span class="token punctuation">#</span> 5.指定不同目录配置文件启动七个节点</span>\n<span class="token list punctuation">-</span> [root@localhost bin]# ./redis-server  /root/7000/redis.conf\n<span class="token list punctuation">-</span> [root@localhost bin]# ./redis-server  /root/7001/redis.conf\n<span class="token list punctuation">-</span> [root@localhost bin]# ./redis-server  /root/7002/redis.conf\n<span class="token list punctuation">-</span> [root@localhost bin]# ./redis-server  /root/7003/redis.conf\n<span class="token list punctuation">-</span> [root@localhost bin]# ./redis-server  /root/7004/redis.conf\n<span class="token list punctuation">-</span> [root@localhost bin]# ./redis-server  /root/7005/redis.conf\n<span class="token list punctuation">-</span> [root@localhost bin]# ./redis-server  /root/7006/redis.conf\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gwtozny7v4j31o70u0k3s.jpg" alt="image-20200627194913866"></p><div class="language-markdown ext-md line-numbers-mode"><pre class="language-markdown"><code><span class="token title important"><span class="token punctuation">#</span> 6.查看进程</span>\n<span class="token list punctuation">-</span> [root@localhost bin]# ps aux|grep redis\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gwtozhd53bj32eo0ewgs8.jpg" alt="image-20200627194954143"></p><h4 id="_1-创建集群" tabindex="-1"><a class="header-anchor" href="#_1-创建集群" aria-hidden="true">#</a> 1.创建集群</h4><div class="language-markdown ext-md line-numbers-mode"><pre class="language-markdown"><code><span class="token title important"><span class="token punctuation">#</span> 1.复制集群操作脚本到bin目录中</span>\n<span class="token list punctuation">-</span> [root@localhost bin]# cp /root/redis-4.0.10/src/redis-trib.rb .\n\n<span class="token title important"><span class="token punctuation">#</span> 2.创建集群</span>\n<span class="token list punctuation">-</span> ./redis-trib.rb create --replicas 1 192.168.202.205:7000 192.168.202.205:7001 192.168.202.205:7002 192.168.202.205:7003 192.168.202.205:7004 192.168.202.205:7005\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gwtozibvpgj31so0u07e4.jpg" alt="image-20200627195601307"></p><div class="language-markdown ext-md line-numbers-mode"><pre class="language-markdown"><code><span class="token title important"><span class="token punctuation">#</span> 3.集群创建成功出现如下提示</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gwtozjnmwyj31cs0u0n4m.jpg" alt="image-20200627195647767"></p><h4 id="_2-查看集群状态" tabindex="-1"><a class="header-anchor" href="#_2-查看集群状态" aria-hidden="true">#</a> 2.查看集群状态</h4><div class="language-markdown ext-md line-numbers-mode"><pre class="language-markdown"><code><span class="token title important"><span class="token punctuation">#</span> 1.查看集群状态 check [原始集群中任意节点] [无]</span>\n<span class="token list punctuation">-</span> ./redis-trib.rb check 192.168.202.205:7000\n\n<span class="token title important"><span class="token punctuation">#</span> 2.集群节点状态说明</span>\n<span class="token list punctuation">-</span> 主节点 \n\t主节点存在hash slots,且主节点的hash slots 没有交叉\n\t主节点不能删除\n\t一个主节点可以有多个从节点\n\t主节点宕机时多个副本之间自动选举主节点\n\n<span class="token list punctuation">-</span> 从节点\n\t从节点没有hash slots\n\t从节点可以删除\n\t从节点不负责数据的写,只负责数据的同步\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h4 id="_3-添加主节点" tabindex="-1"><a class="header-anchor" href="#_3-添加主节点" aria-hidden="true">#</a> 3.添加主节点</h4><div class="language-markdown ext-md line-numbers-mode"><pre class="language-markdown"><code><span class="token title important"><span class="token punctuation">#</span> 1.添加主节点 add-node [新加入节点] [原始集群中任意节点]</span>\n<span class="token list punctuation">-</span> ./redis-trib.rb  add-node 192.168.1.158:7006  192.168.1.158:7005\n<span class="token list punctuation">-</span> 注意:\n\t1.该节点必须以集群模式启动\n\t2.默认情况下该节点就是以master节点形式添加\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="_4-添加从节点" tabindex="-1"><a class="header-anchor" href="#_4-添加从节点" aria-hidden="true">#</a> 4.添加从节点</h4><div class="language-markdown ext-md line-numbers-mode"><pre class="language-markdown"><code><span class="token title important"><span class="token punctuation">#</span> 1.添加从节点 add-node --slave [新加入节点] [集群中任意节点]</span>\n<span class="token list punctuation">-</span> ./redis-trib.rb  add-node --slave 192.168.1.158:7006 192.168.1.158:7000\n<span class="token list punctuation">-</span> 注意:\n\t当添加副本节点时没有指定主节点,redis会随机给副本节点较少的主节点添加当前副本节点\n\t\n<span class="token title important"><span class="token punctuation">#</span> 2.为确定的master节点添加主节点 add-node --slave --master-id master节点id [新加入节点] [集群任意节点]</span>\n<span class="token list punctuation">-</span> ./redis-trib.rb  add-node --slave --master-id 3c3a0c74aae0b56170ccb03a76b60cfe7dc1912e 127.0.0.1:7006  127.0.0.1:7000\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="_5-删除副本节点" tabindex="-1"><a class="header-anchor" href="#_5-删除副本节点" aria-hidden="true">#</a> 5.删除副本节点</h4><div class="language-markdown ext-md line-numbers-mode"><pre class="language-markdown"><code><span class="token title important"><span class="token punctuation">#</span> 1.删除节点 del-node [集群中任意节点] [删除节点id]</span>\n<span class="token list punctuation">-</span> ./redis-trib.rb  del-node 127.0.0.1:7002 0ca3f102ecf0c888fc7a7ce43a13e9be9f6d3dd1\n<span class="token list punctuation">-</span> 注意:\n 1.被删除的节点必须是从节点或没有被分配hash slots的节点\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="_6-集群在线分片" tabindex="-1"><a class="header-anchor" href="#_6-集群在线分片" aria-hidden="true">#</a> 6.集群在线分片</h4><div class="language-markdown ext-md line-numbers-mode"><pre class="language-markdown"><code><span class="token title important"><span class="token punctuation">#</span> 1.在线分片 reshard [集群中任意节点] [无]</span>\n<span class="token list punctuation">-</span> ./redis-trib.rb  reshard  192.168.1.158:7000\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><hr><h2 id="" tabindex="-1"><a class="header-anchor" href="#" aria-hidden="true">#</a></h2>',39),t={},l=(0,a(3744).Z)(t,[["render",function(s,n){return e}]])},3744:(s,n)=>{n.Z=(s,n)=>{const a=s.__vccOpts||s;for(const[s,e]of n)a[s]=e;return a}}}]);