"use strict";(self.webpackChunkblog_tools=self.webpackChunkblog_tools||[]).push([[9456],{3556:(n,s,a)=>{a.r(s),a.d(s,{data:()=>p});const p={key:"v-730ef7d6",path:"/SpringCloud/10-Gateway/10-1-Gateway-in-action.html",title:"",lang:"en-US",frontmatter:{},excerpt:"",headers:[{level:2,title:"10-1 开发网关动态路由",slug:"_10-1-开发网关动态路由",children:[{level:3,title:"创建项目引入网关依赖",slug:"创建项目引入网关依赖",children:[]},{level:3,title:"Java 方式配置路由",slug:"java-方式配置路由",children:[]}]}],filePathRelative:"SpringCloud/10-Gateway/10-1-Gateway-in-action.md",git:{updatedTime:1638143942e3,contributors:[{name:"suanfa8",email:"45396320+suanfa8@users.noreply.github.com",commits:1}]}}},9013:(n,s,a)=>{a.r(s),a.d(s,{default:()=>e});const p=(0,a(6252).uE)('<h2 id="_10-1-开发网关动态路由" tabindex="-1"><a class="header-anchor" href="#_10-1-开发网关动态路由" aria-hidden="true">#</a> 10-1 开发网关动态路由</h2><blockquote><p>实现了网关的路由转发功能。</p></blockquote><p><img src="https://images.gitee.com/uploads/images/2021/1029/135012_e8552113_426516.png" alt="输入图片说明" title="屏幕截图.png"></p><p>网关配置有两种方式：</p><ul><li>一种是快捷方式；</li><li>一种是完全展开方式。</li></ul><h3 id="创建项目引入网关依赖" tabindex="-1"><a class="header-anchor" href="#创建项目引入网关依赖" aria-hidden="true">#</a> 创建项目引入网关依赖</h3><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!-- 引入 gateway 网关依赖 --&gt;</span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gvu859tt0kj31pk07ign5.jpg" alt="image-20200720175051402"></p><p>还需要引入 consul 依赖，和 actuator 健康检查依赖。</p><p><img src="https://images.gitee.com/uploads/images/2021/1029/134003_b0ba0ff7_426516.png" alt="输入图片说明" title="屏幕截图.png"></p><p>方式一：快捷方式配置路由</p><ol start="2"><li>编写网关配置</li></ol><p><code>application.yml</code> 文件。</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>\n  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8989</span>\n\n<span class="token key atrule">spring</span><span class="token punctuation">:</span>\n  <span class="token key atrule">application</span><span class="token punctuation">:</span>\n    <span class="token key atrule">name</span><span class="token punctuation">:</span> gateway\n  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>\n    <span class="token key atrule">consul</span><span class="token punctuation">:</span>\n      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8500</span>\n      <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost\n      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>\n        <span class="token key atrule">service-name</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.application.name<span class="token punctuation">}</span>\n    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>\n      <span class="token key atrule">routes</span><span class="token punctuation">:</span>\n        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> user_route\n          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>9999/\n          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>\n            <span class="token punctuation">-</span> Path=/feign/<span class="token important">**</span>\n        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> product_route\n          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>9998/\n          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>\n            <span class="token punctuation">-</span> Path=/product/<span class="token important">**</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>删除依赖：</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>\n  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8989</span>\n\n<span class="token key atrule">spring</span><span class="token punctuation">:</span>\n  <span class="token key atrule">application</span><span class="token punctuation">:</span>\n    <span class="token key atrule">name</span><span class="token punctuation">:</span> gateway\n  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>\n    <span class="token key atrule">consul</span><span class="token punctuation">:</span>\n      <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost\n      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8500</span>\n    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>\n      <span class="token key atrule">routes</span><span class="token punctuation">:</span>\n        <span class="token comment"># 指定路由唯一标识</span>\n        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> user_route\n          <span class="token comment"># 指定路由服务的地址\t\t\t\t\t\t</span>\n          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>9999/ \n          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>\n            <span class="token comment"># 指定路由规则</span>\n            <span class="token punctuation">-</span> Path=/feign/<span class="token important">**</span>\t\t\t\t\t  \n\n        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> product_route\n          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>9998/\n          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>\n            <span class="token punctuation">-</span> Path=/product/<span class="token important">**</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><blockquote><p>访问：http://localhost:8989/feign/test/findAll 就会转发</p><p>http://localhost:8989/feign/test1?id=1419</p></blockquote><ol start="3"><li>启动 gateway 网关项目</li></ol><p>直接启动报错：</p><p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gvu85g9k5tj329i0d641g.jpg" alt="image-20200720212535357"></p><p>在启动日志中发现，gateway 为了效率使用 webflux 进行异步非阻塞模型的实现，因此和原来的 web 包冲突，去掉原来的 web 即可。</p><p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gvu85jtj0rj327u086gnp.jpg" alt="image-20200720212653494"></p><ul><li>再次启动成功启动</li></ul><p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gvu85ns27bj318n0bo3zg.jpg" alt="image-20200720213657788"></p><ol start="4"><li>测试网关路由转发</li></ol><ul><li>测试通过网关访问用户服务: http://localhost:8989/user/findOne?productId=21</li><li>测试通过网关访问商品服务: http://localhost:8989/product/findOne?productId=1</li></ul><h3 id="java-方式配置路由" tabindex="-1"><a class="header-anchor" href="#java-方式配置路由" aria-hidden="true">#</a> Java 方式配置路由</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GatewayConfig</span> <span class="token punctuation">{</span>\n    <span class="token annotation punctuation">@Bean</span>\n    <span class="token keyword">public</span> <span class="token class-name">RouteLocator</span> <span class="token function">customRouteLocator</span><span class="token punctuation">(</span><span class="token class-name">RouteLocatorBuilder</span> builder<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n                <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;order_route&quot;</span><span class="token punctuation">,</span> r <span class="token operator">-&gt;</span> r<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">&quot;/order/**&quot;</span><span class="token punctuation">)</span>\n                        <span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:9997/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gvu85sccnmj31v80cyju3.jpg" alt="image-20200721103141491"></p>',30),t={},e=(0,a(3744).Z)(t,[["render",function(n,s){return p}]])},3744:(n,s)=>{s.Z=(n,s)=>{const a=n.__vccOpts||n;for(const[n,p]of s)a[n]=p;return a}}}]);